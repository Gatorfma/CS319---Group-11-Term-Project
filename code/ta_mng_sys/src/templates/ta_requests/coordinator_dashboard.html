{% extends 'base.html' %}

{% block title %}TA Request Coordinator Dashboard{% endblock %}

{% block content %}
<div class="layout-content-container px-10">
  <h1 class="py-5">TA Request Coordinator Dashboard</h1>
  
  <!-- Semester selection -->
  <div class="card mb-4">
    <div class="card-body">
      <h3>View Requests by Semester</h3>
      <div class="form-group">
        <select id="semester-select" class="form-select" onchange="changeSemester(this.value)">
          {% for semester in semesters %}
            <option value="{{ semester.id }}" {% if semester.id == current_semester_id %}selected{% endif %}>
              {{ semester.name }} {% if semester.is_active %}(Active){% endif %}
            </option>
          {% endfor %}
        </select>
      </div>
      
      <!-- Export options -->
      <div class="flex gap-3 mt-3">
        <a href="{% url 'ta_requests:export_csv' %}?semester={{ current_semester_id }}" class="btn btn-alt">
          Export as CSV
        </a>
        <a href="{% url 'ta_requests:export_excel' %}?semester={{ current_semester_id }}" class="btn btn-alt">
          Export as Excel
        </a>
        <a href="{% url 'ta_requests:semester_list' %}" class="btn btn-accent">
          Manage Semesters
        </a>
      </div>
    </div>
  </div>
  
  <!-- Requests summary -->
  <div class="card mb-4">
    <div class="card-header">
      <h3>TA Requests Summary</h3>
    </div>
    <div class="card-body">
      <p><strong>Total Requests:</strong> {{ ta_requests|length }}</p>
      
      <!-- Course breakdown -->
      <div class="mt-3">
        <h4>Requests by Course</h4>
        <table class="table">
          <thead>
            <tr>
              <th>Course</th>
              <th>Number of Requests</th>
              <th>Total TA Loads (Min-Max)</th>
              <th>Total Graders</th>
            </tr>
          </thead>
          <tbody>
            {% regroup ta_requests|dictsort:"course.code" by course as course_list %}
            {% for course_group in course_list %}
              <tr>
                <td>{{ course_group.grouper.code }} - {{ course_group.grouper.title }}</td>
                <td>{{ course_group.list|length }}</td>
                <td>
                  {% with course_group.list as requests %}
                    {{ requests|dictsortreversed:"min_ta_loads"|first|default:0 }} - {{ requests|dictsortreversed:"max_ta_loads"|first|default:0 }}
                  {% endwith %}
                </td>
                <td>
                  {% with course_group.list as requests %}
                    {{ requests|dictsortreversed:"graders_requested"|first|default:0 }}
                  {% endwith %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  
  <!-- All requests table -->
  <div class="card">
    <div class="card-header">
      <h3>All TA Requests</h3>
    </div>
    <div class="card-body">
      {% if ta_requests %}
        <table class="table">
          <thead>
            <tr>
              <th>Course</th>
              <th>Instructor</th>
              <th>Min-Max TA Loads</th>
              <th>Graders</th>
              <th>Last Updated</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for request in ta_requests %}
              <tr>
                <td>{{ request.course.code }}</td>
                <td>{{ request.instructor.get_full_name }}</td>
                <td>{{ request.min_ta_loads }} - {{ request.max_ta_loads }}</td>
                <td>{{ request.graders_requested }}</td>
                <td>{{ request.updated_at|date:"M d, Y" }}</td>
                <td>
                  <a href="{% url 'ta_requests:detail' request.id %}" class="btn btn-alt">View Details</a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% else %}
        <p class="text-center">No TA requests found for the selected semester.</p>
      {% endif %}
    </div>
  </div>
</div>

<script>
  function changeSemester(semesterId) {
    window.location.href = `{% url 'ta_requests:coordinator_dashboard' %}?semester=${semesterId}`;
  }
</script>
{% endblock %}